# Work in progress - xmaxima support files for windows
#
# Following files are to be installed in $(prefix)/bin
#
# - xmaxima.exe
# - winkill.exe
# - tclwinkill.dll
prefix=@prefix@
TCLKITSH = tclkitsh-win32.upx.exe
TCLKITDIR = ../../../../programs/star
SDXDIR = $(TCLKITDIR)

MINGW=/mingw
GCCVER=@GCCVER@

# Old windows build system
ifeq ($(GCCVER),3.3.1)
TCLSTUBLIB=-ltclstub84
else
GCCPREFIX=$(MINGW)
TCLSTUBLIB=/c/tcl/lib/tclstub85.lib
endif

all: xmaxima.exe winkill.exe tclwinkill.dll

../xmaxima: 
	(cd ..; $(MAKE) xmaxima)

xmaxima.tcl: ../xmaxima
	cp ../xmaxima xmaxima.tcl

xmaxima.exe: xmaxima.tcl
	rm -rf xmaxima.vfs
	rm -rf img.vfs
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit qwrap xmaxima.tcl && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit unwrap xmaxima.kit && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit unwrap $(SDXDIR)/img.kit && \
	cp -r img.vfs/lib/Img xmaxima.vfs/lib && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit wrap xmaxima.exe \
	-runtime $(TCLKITDIR)/tclkit-win32.upx.exe xmaxima.kit

winkill.exe: winkill.c
	gcc -Wall -o winkill.exe winkill.c

tclwinkill.dll: tclwinkill.c
	gcc -Wall -shared tclwinkill.c $(TCLSTUBLIB) -o tclwinkill.dll


install: xmaxima.exe winkill.exe tclwinkill.dll
	cp xmaxima.exe winkill.exe tclwinkill.dll "@prefix@/bin"
	cp readme*.txt "@prefix@"
