# Work in progress - xmaxima support files for windows
#
# Following files are to be installed in $(prefix)/bin
#
# - xmaxima.exe
# - winkill.exe
# - tclwinkill.dll
prefix=@prefix@
TCLKITSH = tclkitsh-win32.upx.exe
TCLKITDIR = ../../../../programs/star
SDXDIR = $(TCLKITDIR)

MINGW=/mingw
GCCVER=@GCCVER@

# Old windows build system
ifeq ($(GCCVER),3.3.1)
GCCPREFIX=/usr/local
TCLSTUBLIB=-ltclstub84
else
GCCPREFIX=$(MINGW)
TCLSTUBLIB=/c/tcl/lib/tclstub85.lib
endif

all: xmaxima.exe winkill.exe tclwinkill.dll

../xmaxima: 
	(cd ..; $(MAKE) xmaxima)

xmaxima.tcl: ../xmaxima
	cp ../xmaxima xmaxima.tcl

xmaxima.exe: xmaxima.tcl
	rm -rf xmaxima.vfs
	rm -rf img.vfs
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit qwrap xmaxima.tcl && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit unwrap xmaxima.kit && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit unwrap $(SDXDIR)/img.kit && \
	cp -r img.vfs/lib/Img xmaxima.vfs/lib && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit wrap xmaxima.exe \
	-runtime $(TCLKITDIR)/tclkit-win32.upx.exe xmaxima.kit

winkill.exe: winkill.c
	gcc -Wall -o winkill.exe winkill.c

tclwinkill.dll: tclwinkill.c
	gcc -Wall -shared tclwinkill.c $(TCLSTUBLIB) -o tclwinkill.dll

# make conditionals on gcc verison are a bit rough, but work
gcccopy:
	test -d "$(prefix)/bin" || mkdir -p "$(prefix)/bin"
	test -d "$(prefix)/include" || mkdir -p "$(prefix)/include"
	test -d "$(prefix)/include/sys" || mkdir -p "$(prefix)/include/sys"
ifeq ($(GCCVER),3.3.1)
	test -d "$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)/include" \
		|| mkdir -p "$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)/include"
else
	test -d "$(prefix)/lib/gcc/mingw32/$(GCCVER)/include" \
		|| mkdir -p "$(prefix)/lib/gcc/mingw32/$(GCCVER)/include"
	test -d "$(prefix)/libexec/gcc/mingw32/$(GCCVER)" \
		|| mkdir -p "$(prefix)/libexec/gcc/mingw32/$(GCCVER)"
endif
	cp $(GCCPREFIX)/bin/gcc.exe $(prefix)/bin
	cp $(MINGW)/bin/mingwm10.dll $(prefix)/bin
ifeq ($(GCCVER),3.3.1)
	cp $(MINGW)/bin/tclpip84.dll $(prefix)/bin
else
	cp $(GCCPREFIX)/bin/libgmp-10.dll $(prefix)/bin
	cp $(GCCPREFIX)/bin/libmpc-2.dll $(prefix)/bin
	cp $(GCCPREFIX)/bin/libmpfr-1.dll $(prefix)/bin
	cp /c/tcl/bin/tclpip85.dll $(prefix)/bin
endif
	cp $(MINGW)/include/stdio.h $(prefix)/include
	cp $(MINGW)/include/stdlib.h $(prefix)/include
	cp $(MINGW)/include/setjmp.h $(prefix)/include
	cp $(MINGW)/include/_mingw.h $(prefix)/include
	cp $(MINGW)/include/math.h $(prefix)/include
	cp $(MINGW)/include/unistd.h $(prefix)/include
	cp $(MINGW)/include/io.h $(prefix)/include
	cp $(MINGW)/include/process.h $(prefix)/include
	cp $(MINGW)/include/getopt.h $(prefix)/include
	cp $(MINGW)/include/stdint.h $(prefix)/include
	cp $(MINGW)/include/sys/*.h $(prefix)/include/sys
ifeq ($(GCCVER),3.3.1)
	cp $(MINGW)/include/varargs.h $(prefix)/include
	cp $(MINGW)/include/stddef.h $(prefix)/include
	cp $(GCCPREFIX)/lib/gcc-lib/mingw32/$(GCCVER)/cc1.exe \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)
	cp $(MINGW)/bin/as.exe \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/lib/gcc-lib/mingw32/$(GCCVER)/specs  \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/lib/gcc-lib/mingw32/$(GCCVER)/include/*.h  \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)/include
else
	cp $(GCCPREFIX)/libexec/gcc/mingw32/$(GCCVER)/cc1.exe \
		$(prefix)/libexec/gcc/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/libexec/gcc/mingw32/$(GCCVER)/liblto_plugin-0.dll \
		$(prefix)/libexec/gcc/mingw32/$(GCCVER)
	cp $(MINGW)/bin/as.exe \
		$(prefix)/lib/gcc/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/lib/gcc/mingw32/$(GCCVER)/include/*.h  \
		$(prefix)/lib/gcc/mingw32/$(GCCVER)/include
endif

install: xmaxima.exe winkill.exe tclwinkill.dll
	cp xmaxima.exe winkill.exe tclwinkill.dll "@prefix@/bin"
	cp readme*.txt "@prefix@"
